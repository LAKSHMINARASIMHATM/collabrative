{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///D:/real-time-code-editor%20%282%29/lib/collaboration/collaboration-context.tsx"],"sourcesContent":["'use client';\n\nimport React, { createContext, useContext, useEffect, useState, ReactNode, useRef, useMemo } from 'react';\nimport * as Y from 'yjs';\nimport { WebsocketProvider } from 'y-websocket';\n// Basic User interface compatible with previous usage\ninterface User {\n  id?: string;\n  info?: any;\n  [key: string]: any;\n}\n\ntype Collaborator = User & { id: string | number };\n\ninterface CollaborationContextType {\n  users: Collaborator[];\n  code: string;\n  setCode: (code: string) => void;\n  cursorPosition: { x: number; y: number };\n  setCursorPosition: (position: { x: number; y: number }) => void;\n  undo: () => void;\n  redo: () => void;\n  canUndo: boolean;\n  canRedo: boolean;\n  room: any;\n  provider: WebsocketProvider | null;\n  doc: Y.Doc | null;\n  yText: Y.Text | null;\n  chatMessages: ChatMessage[];\n  sendMessage: (content: string, user: any) => void;\n  isConnected: boolean;\n  isLoading: boolean;\n  error: string | null;\n  retry: () => void;\n}\n\nconst CollaborationContext = createContext<CollaborationContextType | null>(null);\n\nimport type { ChatMessage } from './types';\n\ninterface CollaborationProviderProps {\n  children: ReactNode;\n  roomId: string;\n  roomPassword?: string;\n  initialCode?: string;\n  onAuthError?: (error: string) => void;\n  user?: { id: string } | null;\n}\n\nexport function CollaborationProvider({\n  children,\n  roomId: roomId,\n  roomPassword: roomPassword = '',\n  initialCode = '',\n  onAuthError,\n  user\n}: CollaborationProviderProps) {\n  const [users, setUsers] = useState<Collaborator[]>([]);\n  const [code, setCode] = useState(initialCode); // Local mirror\n  const [provider, setProvider] = useState<WebsocketProvider | null>(null);\n  const [doc] = useState<Y.Doc>(() => new Y.Doc());\n  const yText = useRef<Y.Text>(new Y.Text());\n  const [isConnected, setIsConnected] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [connectionStatus, setConnectionStatus] = useState<'connected' | 'disconnected' | 'reconnecting'>('disconnected');\n\n  // Chat state\n  const [chatMessages, setChatMessages] = useState<ChatMessage[]>([]);\n  const chatArrayRef = useRef<Y.Array<any> | null>(null);\n\n  // Awareness state\n  const [cursorPosition, setCursorInfo] = useState({ x: 0, y: 0 });\n\n  // Initialize Y.Text with initial code\n  useEffect(() => {\n    if (initialCode && yText.current) {\n      const text = yText.current;\n      text.delete(0, text.length);\n      text.insert(0, initialCode);\n    }\n  }, [initialCode]);\n\n  // Memoize dependencies to avoid TypeScript parsing issues\n  const memoizedRoomId = useMemo(() => roomId, [roomId]);\n  const memoizedRoomPassword = useMemo(() => roomPassword, [roomPassword]);\n  const memoizedUserId = useMemo(() => user?.id, [user?.id]);\n  const memoizedOnAuthError = useMemo(() => onAuthError, [onAuthError]);\n\n  // Initialize Yjs and WebSocket connection\n  useEffect(() => {\n    if (typeof window === 'undefined') return;\n\n    let wsProvider: WebsocketProvider | null = null;\n    let connectionTimeout: NodeJS.Timeout | null = null;\n\n    let retryCount = 0;\n    const maxRetries = 3;\n    const retryDelay = 2000; // 2 seconds\n\n    const attemptConnection = async () => {\n      try {\n        setIsLoading(true);\n        setError(null);\n\n        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n        // Collaboration server runs on port 3001\n        const wsUrl = `${wsProtocol}//${window.location.hostname}:3001`;\n\n        console.log(`Attempting WebSocket connection to: ${wsUrl} (Attempt ${retryCount + 1}/${maxRetries})`);\n\n        // Initialize WebSocket provider with authentication\n        wsProvider = new WebsocketProvider(wsUrl, memoizedRoomId, doc, {\n          connect: true,\n          params: {\n            password: memoizedRoomPassword,\n            userId: memoizedUserId || 'anonymous',\n          },\n        });\n\n        // Add connection timeout\n        connectionTimeout = setTimeout(() => {\n          if (!isConnected) {\n            console.warn('WebSocket connection timeout - server may be unavailable');\n            if (retryCount < maxRetries - 1) {\n              retryCount++;\n              console.log(`Retrying connection in ${retryDelay}ms... (${retryCount}/${maxRetries})`);\n              setTimeout(attemptConnection, retryDelay);\n            } else {\n              setError('WebSocket connection timeout after multiple attempts. Collaboration features will be disabled.');\n              setIsLoading(false);\n              console.log('Entering fallback mode - collaboration disabled');\n            }\n          }\n        }, 10000); // 10 second timeout\n\n        wsProvider.on('status', (event: { status: string }) => {\n          const connected = event.status === 'connected';\n          setIsConnected(connected);\n          setConnectionStatus(event.status as any);\n\n          if (connected) {\n            setIsLoading(false);\n            setError(null);\n          }\n        });\n\n        wsProvider.on('connection-close', (event: any) => {\n          // Only log abnormal closures to reduce console noise\n          if (event && event.code === 1006) {\n            console.warn('WebSocket connection closed abnormally - server may be down');\n          }\n          setIsConnected(false);\n          setConnectionStatus('disconnected');\n\n          if (event && event.code === 1006) { // Connection closed abnormally\n            const errorMsg = 'WebSocket server unavailable. Please ensure the server is running.';\n            setError(errorMsg);\n            onAuthError?.(errorMsg);\n          } else if (event && event.code === 1000) { // Normal closure\n            setError(null); // Clear error on normal closure\n          }\n        });\n\n        wsProvider.on('connection-error', (event: any) => {\n          // Reduce console noise by only logging on first attempt or final failure\n          if (retryCount === 0 || retryCount === maxRetries - 1) {\n            console.warn('WebSocket connection error - server unavailable');\n          }\n          setIsConnected(false);\n\n          let errorMsg = 'Failed to connect to WebSocket server.';\n\n          // Check for specific error types\n          if (event?.error?.message?.includes('WebSocket is closed before the connection is established')) {\n            errorMsg = 'WebSocket server is not running or not accessible.';\n          } else if (event?.error?.message?.includes('ECONNREFUSED')) {\n            errorMsg = 'Connection refused. Please ensure the WebSocket server is running on port 3001.';\n          } else if (event?.error?.message?.includes('Network error')) {\n            errorMsg = 'Network error. Please check your connection and server availability.';\n          } else {\n            errorMsg = 'Failed to connect to WebSocket server.';\n          }\n\n          if (retryCount < maxRetries - 1) {\n            retryCount++;\n            console.log(`Retrying connection in ${retryDelay}ms... (${retryCount}/${maxRetries})`);\n            setTimeout(attemptConnection, retryDelay);\n          } else {\n            errorMsg += ' Collaboration features will be disabled until the server is available.';\n            setError(errorMsg);\n            onAuthError?.(errorMsg);\n            setIsLoading(false);\n            console.log('Entering fallback mode - collaboration disabled');\n          }\n        });\n\n        setProvider(wsProvider);\n      } catch (err) {\n        // Reduce console noise - only log on first attempt or final failure\n        if (retryCount === 0 || retryCount === maxRetries - 1) {\n          console.warn('WebSocket setup failed - server may be unavailable');\n        }\n        let errorMsg = 'Failed to connect to room';\n\n        if (err instanceof Error) {\n          if (err.message.includes('WebSocket is closed before the connection is established')) {\n            errorMsg = 'WebSocket server is not running.';\n          } else {\n            errorMsg = err.message;\n          }\n        }\n\n        if (retryCount < maxRetries - 1) {\n          retryCount++;\n          console.log(`Retrying connection in ${retryDelay}ms... (${retryCount}/${maxRetries})`);\n          setTimeout(attemptConnection, retryDelay);\n        } else {\n          errorMsg += ' Collaboration features will be disabled until the server is available.';\n          setError(errorMsg);\n          onAuthError?.(errorMsg);\n          setIsLoading(false);\n          console.log('Entering fallback mode - collaboration disabled');\n        }\n      }\n    };\n\n    // Start the connection process\n    attemptConnection();\n\n    return () => {\n      if (wsProvider) {\n        wsProvider.destroy();\n      }\n      // Clear any pending timeout\n      if (connectionTimeout) {\n        clearTimeout(connectionTimeout);\n      }\n    };\n  }, [memoizedRoomId, memoizedRoomPassword, memoizedUserId, memoizedOnAuthError]);\n\n  // Cursor handling wrapper\n  const setCursorPosition = (pos: { x: number; y: number }) => {\n    setCursorInfo(pos);\n    if (provider) {\n      provider.awareness.setLocalStateField('cursor', pos);\n    }\n  };\n\n  // Undo/Redo - usually handled by Y.UndoManager attached to editor\n  // We can expose simple wrappers or letting the editor handle it.\n  // For now, no-op or basic implementation if we had UndoManager here.\n  const undo = () => { };\n  const redo = () => { };\n\n  // Compatibility setCode - imperfect for concurrent edits if not bound via MonacoBinding\n  // Use this only for initialization or non-editor updates\n  const handleCodeChange = (newCode: string) => {\n    if (yText.current && yText.current.toString() !== newCode) {\n      const text = yText.current;\n      text.delete(0, text.length);\n      text.insert(0, newCode);\n    }\n  };\n\n  // --- Send chat message ---\n  const sendMessage = (content: string, user: any) => {\n    if (!chatArrayRef.current) return;\n    const msg = {\n      id: Date.now().toString(),\n      userId: user.id || 'anonymous',\n      userName: user.name || user.email || 'User',\n      content,\n      timestamp: new Date().toISOString(),\n    };\n    chatArrayRef.current.push([msg]);\n  };\n\n  // Get Y.Text for Monaco binding\n  const sharedText = useMemo(() => doc.getText('monaco'), [doc]);\n\n  const contextValue: CollaborationContextType = {\n    users,\n    code,\n    setCode: handleCodeChange,\n    cursorPosition,\n    setCursorPosition,\n    undo,\n    redo,\n    canUndo: false,\n    canRedo: false,\n    room: null,\n    provider,\n    doc,\n    yText: sharedText,\n    chatMessages,\n    sendMessage,\n    isConnected,\n    isLoading,\n    error,\n    retry: () => {\n      setError(null);\n      setIsLoading(true);\n      // Reconnect logic will be triggered by the effect\n    },\n  };\n\n  return (\n    <CollaborationContext.Provider value={contextValue}>\n      {children}\n      <div className={`fixed bottom-4 right-4 p-2 rounded-md text-sm ${connectionStatus === 'connected' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'\n        }`}>\n        Status: {connectionStatus}\n      </div>\n    </CollaborationContext.Provider>\n  );\n}\n\nexport const useCollaboration = (): CollaborationContextType => {\n  const context = useContext(CollaborationContext);\n\n  if (!context) {\n    throw new Error('useCollaboration must be used within a CollaborationProvider');\n  }\n\n  return context;\n};\n\nexport const ClientSideSuspense = ({ children }: any) => {\n  return <>{children}</>;\n};\n\n"],"names":[],"mappings":"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"}}]
}